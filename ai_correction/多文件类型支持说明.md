# 多文件类型支持功能说明

## 📋 功能概述

增强版的 `call_api` 函数现在支持处理多种文件类型，包括：

- **图像文件**: JPG, PNG, GIF, BMP, TIFF, WebP
- **PDF文档**: PDF文件（既可以作为图像处理，也可以提取文本）
- **Word文档**: DOC, DOCX文件
- **文本文件**: TXT, MD, RTF, CSV文件
- **代码文件**: PY, JS, HTML, CSS, JSON, XML, YAML等

## 🔧 新增功能

### 1. 文件类型检测 (`get_file_type`)
```python
def get_file_type(file_path):
    """
    检测文件类型，返回文件类型分类
    
    返回值:
    - 'image': 图片文件
    - 'pdf': PDF文件  
    - 'word': Word文档
    - 'text': 纯文本文件
    - 'unknown': 未知类型
    """
```

### 2. PDF文件处理 (`read_pdf_file`)
- 支持 PyPDF2 和 pdfplumber 两种PDF处理库
- 自动提取PDF中的文本内容
- 优雅的错误处理和库缺失提示

### 3. Word文档处理 (`read_word_file`)
- 使用 python-docx 库处理Word文档
- 提取文档中的文本内容
- 支持 .doc 和 .docx 格式

### 4. 智能文件内容处理 (`process_file_content`)
- 根据文件类型自动选择处理方式
- 统一的错误处理机制
- 返回处理状态和内容

### 5. 增强的API调用 (`call_api`)
- 参数名从 `*input_images` 改为 `*input_files`，更准确地反映功能
- 添加文件处理摘要，显示每个文件的处理状态
- 更好的错误处理和回退机制

## 📦 依赖安装

为了支持所有文件类型，需要安装以下依赖：

```bash
# 基础依赖（已有）
pip install openai requests pathlib

# PDF处理依赖（选择一个）
pip install PyPDF2
# 或者
pip install pdfplumber

# Word文档处理依赖
pip install python-docx
```

### 依赖安装脚本
```bash
# 安装所有推荐依赖
pip install PyPDF2 python-docx pdfplumber

# 或者创建 requirements.txt
echo "PyPDF2>=3.0.0" >> requirements.txt
echo "python-docx>=0.8.11" >> requirements.txt
echo "pdfplumber>=0.7.0" >> requirements.txt
pip install -r requirements.txt
```

## 🎯 使用示例

### 基本使用
```python
from functions.api_correcting.calling_api import call_api

# 处理混合文件类型
result = call_api(
    "请批改这些文件中的内容",
    "题目.jpg",           # 图像文件
    "答案.pdf",           # PDF文件
    "评分标准.docx",      # Word文档
    "补充说明.txt",       # 文本文件
    strictness_level="中等",
    language="zh"
)
```

### 文件类型检测
```python
from functions.api_correcting.calling_api import get_file_type

# 检测文件类型
file_type = get_file_type("document.pdf")  # 返回 'pdf'
file_type = get_file_type("image.jpg")     # 返回 'image'
file_type = get_file_type("text.txt")      # 返回 'text'
```

### 单独处理文件内容
```python
from functions.api_correcting.calling_api import process_file_content

# 处理单个文件
content_type, content = process_file_content("document.pdf")
if content_type == 'text':
    print("PDF内容:", content)
elif content_type == 'error':
    print("处理失败:", content)
```

## 📊 处理流程

1. **文件类型检测**: 根据文件扩展名确定处理方式
2. **内容提取**: 
   - 图像文件 → Base64编码用于视觉处理
   - PDF文件 → 提取文本内容
   - Word文档 → 提取文本内容
   - 文本文件 → 直接读取内容
3. **内容整合**: 将所有文本内容整合到提示词中
4. **API调用**: 发送给AI模型进行处理
5. **结果返回**: 返回处理后的自然语言结果

## 🔍 错误处理

### 库缺失处理
- PDF处理: 如果PyPDF2和pdfplumber都不可用，会返回友好的错误提示
- Word处理: 如果python-docx不可用，会返回安装提示

### 文件读取失败
- 编码错误: 自动尝试UTF-8、GBK、Latin-1编码
- 文件损坏: 返回具体的错误信息
- 权限问题: 提供清晰的错误说明

### 回退机制
- 图像处理失败时，尝试作为文本文件处理
- 未知文件类型时，尝试作为文本文件读取
- 所有方法都失败时，返回友好的错误信息

## 📈 性能优化

1. **延迟导入**: 只在需要时导入PDF和Word处理库
2. **错误缓存**: 避免重复处理失败的文件
3. **内存管理**: 及时释放大文件的内存占用
4. **批处理**: 支持同时处理多个文件

## 🛡️ 安全考虑

1. **文件类型验证**: 严格检查文件扩展名
2. **路径安全**: 使用Path对象处理文件路径
3. **错误隔离**: 单个文件处理失败不影响其他文件
4. **内容过滤**: 对提取的内容进行基本的安全检查

## 🚀 未来扩展

### 计划支持的文件类型
- **Excel文件**: XLS, XLSX
- **PowerPoint**: PPT, PPTX  
- **压缩文件**: ZIP, RAR（提取并处理内部文件）
- **音频文件**: MP3, WAV（语音转文字）
- **视频文件**: MP4, AVI（提取关键帧和字幕）

### 功能增强
- **文件预处理**: 图像增强、文本清理
- **内容分析**: 自动识别文档结构
- **批量处理**: 支持文件夹批量处理
- **缓存机制**: 缓存已处理的文件内容

## 📝 使用注意事项

1. **文件大小**: 建议单个文件不超过10MB
2. **文件数量**: 建议一次处理不超过20个文件
3. **编码问题**: 确保文本文件使用UTF-8编码
4. **权限问题**: 确保程序有读取文件的权限

## 🔧 故障排除

### 常见问题

**Q: PDF文件无法读取？**
A: 安装PDF处理库：`pip install PyPDF2 pdfplumber`

**Q: Word文档处理失败？**
A: 安装Word处理库：`pip install python-docx`

**Q: 文本文件乱码？**
A: 确保文件使用UTF-8编码，或者程序会自动尝试其他编码

**Q: 处理速度慢？**
A: 减少同时处理的文件数量，或者将大文件分割成小文件

### 调试模式
```python
# 启用详细日志
import logging
logging.basicConfig(level=logging.DEBUG)

# 测试单个文件处理
content_type, content = process_file_content("test.pdf")
print(f"类型: {content_type}")
print(f"内容: {content[:200]}...")  # 显示前200字符
```

---

**更新日期**: 2024年最新
**版本**: v2.0 - 多文件类型支持版本
**兼容性**: 向后兼容原有API接口 