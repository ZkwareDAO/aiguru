# 生产级 LangGraph AI 批改系统 - 需求文档

## 📋 系统概述

### 系统目标
构建一个**生产级的、可扩展的 AI 批改系统**，能够：
- 对学生答卷进行**精细化、逐题批改**
- 提供**具体的错误定位和分层次反馈**
- 支持**多题型**（选择题、填空题、解答题、作文等）
- 进行**班级/学生维度的数据分析**
- 实现**高效的流式处理**和**Token优化**

### 核心价值
1. **精细化批改** - 从整体批改升级到逐题批改
2. **数据驱动** - 从孤立结果升级到可分析的数据
3. **高效处理** - 从AI过载升级到智能拆分
4. **用户友好** - 从黑盒处理升级到实时反馈

---

## 🎯 核心功能需求

### 1. 逐题批改功能
**问题**：当前系统整体批改，无法精确定位每道题的错误

**需求**：
- ✅ 自动识别和分解题目（从文本中提取单个题目）
- ✅ 识别题型（选择题、填空题、解答题、作文等）
- ✅ 对每道题单独批改，生成独立的得分和反馈
- ✅ 支持不同题型的差异化批改策略

**实现方式**：
- InputParser Agent 解析题目和答案
- QuestionAnalyzer Agent 识别题型
- QuestionGrader Agent 逐题批改

### 2. 错误定位与标注
**问题**：批改结果无法指出具体错误位置

**需求**：
- ✅ 生成错误的**文本位置标注**（段落号、句号、字符位置）
- ✅ 标注错误**类型**（语法错误、逻辑错误、知识点错误等）
- ✅ 标注错误**严重程度**（致命/严重/轻微）
- ✅ 提供**改进建议**（如何修正）

**实现方式**：
- QuestionGrader Agent 返回详细的错误信息
- 包含位置、类型、严重程度、建议

### 3. 分层次反馈
**问题**：反馈过于笼统，学生难以理解

**需求**：
- ✅ **第一层**：得分和等级（快速反馈）
- ✅ **第二层**：错误分析（具体错误是什么）
- ✅ **第三层**：改进建议（如何改进）
- ✅ **第四层**：知识点分析（涉及哪些知识点）

**实现方式**：
- 在GradingState中存储多层次的反馈
- 前端根据需要展示不同层次

### 4. 学生识别与管理
**问题**：无法区分不同学生的答卷

**需求**：
- ✅ 从文件名中提取学生信息（如"张三_数学_2024.txt"）
- ✅ 从答卷文本中提取学生信息（如"学号：001"）
- ✅ 支持用户手动指定学生信息
- ✅ 将批改结果与学生关联

**实现方式**：
- InputParser Agent 提取学生信息
- 数据库存储学生-批改结果的关联

### 5. 数据分析与统计
**问题**：批改结果是孤立的，无法进行班级维度的分析

**需求**：
- ✅ **学生维度**：个人得分、错误类型分布、知识点掌握度
- ✅ **班级维度**：平均分、及格率、知识点掌握度分布
- ✅ **题目维度**：题目难度、错误率、常见错误
- ✅ **知识点维度**：知识点掌握度、需要加强的知识点

**实现方式**：
- ResultAggregator Agent 聚合统计数据
- DataPersistence Agent 存储到数据库
- 前端展示统计图表

### 6. 流式处理与进度反馈
**问题**：处理时间长，用户无法了解进度

**需求**：
- ✅ 实时显示处理进度（当前处理的题目、已完成的题目数）
- ✅ 支持**流式返回结果**（不等待全部完成）
- ✅ 支持**断点续传**（中断后可继续）
- ✅ 显示预计剩余时间

**实现方式**：
- LangGraph 流式处理
- Streamlit session_state 实时更新进度
- WebSocket 或 Server-Sent Events 推送进度

---

## 👥 用户故事

### 故事 1：教师批改班级作业
**角色**：数学教师
**场景**：需要批改班级30名学生的数学作业
**需求**：
1. 上传题目、标准答案、评分标准
2. 批量上传学生答卷（30份）
3. 系统自动识别学生信息
4. 逐题批改，生成详细反馈
5. 查看班级统计（平均分、知识点掌握度）
6. 导出批改结果

**预期结果**：
- 30份答卷在5分钟内完成批改
- 每份答卷有详细的逐题反馈
- 班级统计数据清晰可见

### 故事 2：学生查看批改反馈
**角色**：学生
**场景**：查看自己的批改结果
**需求**：
1. 查看总分和等级
2. 查看每道题的得分和反馈
3. 查看错误位置和改进建议
4. 了解自己的知识点掌握情况

**预期结果**：
- 清晰的逐题反馈
- 具体的错误位置标注
- 可操作的改进建议

### 故事 3：教研组分析教学效果
**角色**：教研组长
**场景**：分析全年级学生的学习情况
**需求**：
1. 查看全年级的统计数据
2. 识别学生的共同知识点弱点
3. 评估教学效果
4. 制定改进计划

**预期结果**：
- 多维度的统计数据
- 清晰的数据可视化
- 可导出的分析报告

---

## 🔧 技术约束与依赖

### 约束条件
1. **不包含 OCR**：输入已是文本形式，不需要图像识别
2. **以 Streamlit 为核心**：所有功能通过 `ai_correction/streamlit_simple.py` 访问
3. **生产级质量**：必须可靠稳定，能真正上线使用
4. **解决实际问题**：专注于核心痛点，不添加不必要功能

### 技术栈
- **后端框架**：FastAPI（在 `new_aicorrection/backend` 中）
- **前端框架**：Streamlit（`ai_correction/streamlit_simple.py`）
- **工作流编排**：LangGraph
- **LLM**：Gemini/GPT（通过 OpenRouter）
- **数据库**：PostgreSQL 或 MySQL（部署在 Railway）
- **认证**：Firebase Auth
- **部署**：Railway

### 依赖关系
```
Streamlit UI
    ↓
LangGraph Workflow
    ↓
LLM API (Gemini/GPT)
    ↓
Database (PostgreSQL/MySQL)
```

---

## 📊 成功指标

| 指标 | 目标 | 说明 |
|------|------|------|
| **批改速度** | 30份答卷 < 5分钟 | 平均每份答卷 < 10秒 |
| **准确度** | > 90% | 与人工批改的一致性 |
| **Token成本** | < 50% 原始成本 | 通过优化和缓存 |
| **用户满意度** | > 4.5/5 | 通过问卷调查 |
| **系统可用性** | > 99.5% | 月度可用性 |

---

## 📅 优先级

### P0（必需）
- [ ] 逐题批改功能
- [ ] 错误定位与标注
- [ ] 学生识别与管理
- [ ] 基础数据统计

### P1（重要）
- [ ] 分层次反馈
- [ ] 流式处理与进度反馈
- [ ] 班级维度分析
- [ ] 知识点分析

### P2（可选）
- [ ] 断点续传
- [ ] 高级数据可视化
- [ ] 导出功能
- [ ] 多语言支持

