# 智能分值分析系统 - 解决多种做法的复杂分值计算

## 问题背景

用户指出的核心问题：
> "想办法让AI判断题目的批改标准是否包含多种做法，如果是，那总分值就不是简单的分值识别，因为在另类做法处也同样有分值，而这个分值与前面的做法的分值是独立的"

具体场景：
- 题目标注：`(7 marks)`
- 主要做法：`(a) 4分, (b) 3分`
- 黑框另类做法：也有独立的分值分配
- 问题：AI错误地将两种做法的分值相加

## 解决方案设计

### 1. 多种做法检测机制

新增 `get_method_variety_detection()` 函数，通过以下指标检测：

**视觉标记检测**：
- 黑框、虚线框等特殊标记
- "Alternative"、"另类"、"Other method"等关键词
- "OR"、"或者"等选择性连接词

**结构模式检测**：
- 明显的两段式或多段式解法
- "Method 1"、"Method 2"等标识
- 相同题目的不同解答路径

**分值模式检测**：
- 不同位置的多套分值标注
- "1M+1M+1A"这样的分值并列出现

### 2. 智能分值分析系统

新增 `get_intelligent_score_analysis()` 函数，实现：

#### 分值结构分析
- **情况1**：标准分值分解 → 总分 = 题目标注分值
- **情况2**：多种做法并列 → 总分 = 题目标注分值（不累加）
- **情况3**：复杂多步骤 → 深度分析分值结构

#### 分值计算逻辑
1. **题目总分确定**：
   - 优先级1：题目旁明确标注的总分
   - 优先级2：批改方案中明确说明的总分
   - ❌ 禁止：将不同做法的分值相加

2. **评分路径选择**：
   - 学生使用主要做法 → 按主要做法标准评分
   - 学生使用另类做法 → 按另类做法标准评分
   - 学生混合使用 → 选择对学生最有利的方式

#### 关键原则
- **总分不累加**：总分就是题目标注的分值
- **方法选择自由**：学生可选择任一方法
- **评分灵活性**：根据学生方法选择评分标准

### 3. 输出格式标准化

要求AI在批改前输出：
```
📊 **分值结构分析结果**：
├─ 题目标注总分：(X marks)
├─ 主要做法分值：[具体分解]
├─ 另类做法分值：[具体分解] (如果存在)
├─ 分值关系判断：[并列/累加/复杂]
└─ 最终确认总分：X分

评分策略：根据学生使用的方法选择相应的评分标准
```

## 技术实现

### 修改的文件
1. **functions/api_correcting/prompts.py**
   - 新增 `get_method_variety_detection()`
   - 新增 `get_intelligent_score_analysis()`

2. **functions/api_correcting/calling_api.py**
   - 在 `batch_correction_with_standard()` 中集成智能分析
   - 在 `batch_correction_without_standard()` 中集成智能分析
   - 将智能分析提升到最高优先级

### 集成顺序
```python
# 最高优先级：智能分值分析
prompt = prompts.get_method_variety_detection() + "\n\n" + prompt
prompt = prompts.get_intelligent_score_analysis() + "\n\n" + prompt

# 其他增强功能...
```

## 解决的具体问题

### 问题案例
- 题目：`Question 5 (7 marks)`
- 主要做法：建立方程组 → 求解 → 答案 (总体4-5步)
- 黑框另类做法：分数计算法 → 简化 → 答案 (1M+1M+1M+1A)

### 错误处理方式
❌ **错误**：主要做法7分 + 另类做法4分 = 11分总分

### 正确处理方式
✅ **正确**：
- 题目总分：7分（来自题目标注）
- 学生可选择任一方法达到7分满分
- 如果学生用主要做法 → 按主要做法评分标准
- 如果学生用另类做法 → 按另类做法评分标准

## 系统优势

1. **智能检测**：自动识别批改方案中的多种做法
2. **正确理解**：区分并列关系和累加关系
3. **灵活评分**：为每种做法制定专门标准
4. **公平性**：确保学生可自由选择解题方法
5. **准确性**：避免分值计算错误

## 测试验证

创建了 `test_intelligent_scoring.py` 测试脚本，验证：
- 多种做法检测机制的准确性
- 智能分值分析的逻辑正确性
- 复杂情况的处理能力
- 输出格式的清晰性

## 实际应用效果

通过这个智能分值分析系统，AI将能够：
- ✅ 正确识别题目的真实总分值
- ✅ 理解批改方案中多种做法的关系
- ✅ 避免错误的分值累加
- ✅ 为学生提供公平的评分
- ✅ 支持多样化的解题方法

这彻底解决了用户提出的"另类做法分值独立性"问题，确保AI能够正确处理包含多种做法的复杂批改方案。 