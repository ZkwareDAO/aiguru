# LangGraph Agent è¯¦ç»†è®¾è®¡æ–‡æ¡£

## ğŸ“‹ Agent è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªAgentåªåšä¸€ä»¶äº‹
2. **æ¸…æ™°æ¥å£**ï¼šæ˜ç¡®çš„è¾“å…¥/è¾“å‡º
3. **å¯æµ‹è¯•æ€§**ï¼šæ˜“äºå•å…ƒæµ‹è¯•
4. **å¯æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
5. **å®¹é”™æ€§**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†

---

## ğŸ” InputParser Agent è¯¦ç»†è®¾è®¡

### åŠŸèƒ½æè¿°
è§£æä¸Šä¼ çš„æ–‡ä»¶ï¼Œæå–é¢˜ç›®ã€ç­”æ¡ˆã€å­¦ç”Ÿä¿¡æ¯

### è¾“å…¥æ ¼å¼æ”¯æŒ
```
æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼š
- .txt çº¯æ–‡æœ¬
- .md Markdown
- .json ç»“æ„åŒ–æ•°æ®
- .csv è¡¨æ ¼æ•°æ®

é¢˜ç›®æ ¼å¼ç¤ºä¾‹ï¼š
1. è¿™æ˜¯ç¬¬ä¸€é“é¢˜
   A. é€‰é¡¹A
   B. é€‰é¡¹B
   C. é€‰é¡¹C
   D. é€‰é¡¹D

2. è¿™æ˜¯ç¬¬äºŒé“é¢˜
   ___________

3. è¿™æ˜¯ç¬¬ä¸‰é“é¢˜
   ç­”æ¡ˆï¼š___________
```

### æ ¸å¿ƒç®—æ³•
```python
def parse_questions(text: str) -> List[Dict]:
    """
    è§£æé¢˜ç›®
    
    æ­¥éª¤ï¼š
    1. æŒ‰é¢˜å·åˆ†å‰²ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼š1. / (1) / 1) / ç¬¬1é¢˜ï¼‰
    2. æå–é¢˜ç›®æ–‡æœ¬
    3. è¯†åˆ«é¢˜å‹ï¼ˆé€šè¿‡ç‰¹å¾è¯†åˆ«ï¼‰
    4. æå–é€‰é¡¹ï¼ˆå¦‚æœæ˜¯é€‰æ‹©é¢˜ï¼‰
    5. è¿”å›ç»“æ„åŒ–æ•°æ®
    """
    
def extract_student_info(filename: str, text: str) -> Dict:
    """
    æå–å­¦ç”Ÿä¿¡æ¯
    
    ä¼˜å…ˆçº§ï¼š
    1. ä»æ–‡ä»¶åæå–ï¼ˆå¦‚ "001_å¼ ä¸‰_æ•°å­¦.txt"ï¼‰
    2. ä»æ–‡æœ¬å¼€å¤´æå–ï¼ˆå¦‚ "å­¦å·ï¼š001\nå§“åï¼šå¼ ä¸‰"ï¼‰
    3. ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
    """
    
def match_answers(questions: List[Dict], answers: List[Dict]) -> List[Dict]:
    """
    åŒ¹é…ç­”æ¡ˆä¸é¢˜ç›®
    
    æ­¥éª¤ï¼š
    1. æŒ‰é¢˜å·åŒ¹é…
    2. å¤„ç†é¢˜å·ä¸åŒ¹é…çš„æƒ…å†µ
    3. è¿”å›å®Œæ•´çš„é¢˜ç›®-ç­”æ¡ˆå¯¹
    """
```

### é”™è¯¯å¤„ç†
- æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ â†’ è¿”å›é”™è¯¯ä¿¡æ¯
- é¢˜ç›®è§£æå¤±è´¥ â†’ è®°å½•å¤±è´¥çš„é¢˜ç›®ï¼Œç»§ç»­å¤„ç†
- å­¦ç”Ÿä¿¡æ¯ç¼ºå¤± â†’ æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥

### è¾“å‡ºç¤ºä¾‹
```json
{
  "questions": [
    {
      "id": 1,
      "text": "è¿™æ˜¯ç¬¬ä¸€é“é¢˜",
      "type": "choice",
      "options": ["A. é€‰é¡¹A", "B. é€‰é¡¹B", "C. é€‰é¡¹C", "D. é€‰é¡¹D"],
      "raw_text": "1. è¿™æ˜¯ç¬¬ä¸€é“é¢˜\n   A. é€‰é¡¹A\n   B. é€‰é¡¹B\n   C. é€‰é¡¹C\n   D. é€‰é¡¹D"
    }
  ],
  "answers": [
    {
      "question_id": 1,
      "text": "B",
      "student_id": "001",
      "student_name": "å¼ ä¸‰"
    }
  ],
  "student_info": {
    "id": "001",
    "name": "å¼ ä¸‰",
    "class": "é«˜ä¸€(1)ç­"
  }
}
```

---

## ğŸ¯ QuestionAnalyzer Agent è¯¦ç»†è®¾è®¡

### åŠŸèƒ½æè¿°
åˆ†æé¢˜ç›®ç‰¹å¾ï¼Œè¯†åˆ«é¢˜å‹ã€éš¾åº¦ã€æ‰¹æ”¹ç­–ç•¥

### é¢˜å‹è¯†åˆ«è§„åˆ™
```python
QUESTION_TYPES = {
    'choice': {
        'features': ['é€‰é¡¹', 'A.', 'B.', 'C.', 'D.'],
        'strategy': 'keyword_match',
        'expected_answer_length': 'short'
    },
    'fill': {
        'features': ['___', 'ç©ºç™½', 'å¡«ç©º'],
        'strategy': 'semantic',
        'expected_answer_length': 'short'
    },
    'essay': {
        'features': ['è®ºè¿°', 'åˆ†æ', 'è¯´æ˜', 'æè¿°'],
        'strategy': 'rubric',
        'expected_answer_length': 'long'
    },
    'calculation': {
        'features': ['è®¡ç®—', 'æ±‚', 'è§£', 'è¯æ˜'],
        'strategy': 'step_by_step',
        'expected_answer_length': 'medium'
    }
}
```

### éš¾åº¦è¯„ä¼°
```python
def estimate_difficulty(question: Dict) -> str:
    """
    è¯„ä¼°é¢˜ç›®éš¾åº¦
    
    å› ç´ ï¼š
    1. é¢˜ç›®é•¿åº¦ï¼ˆé•¿ = éš¾ï¼‰
    2. å…³é”®è¯ï¼ˆå¤æ‚è¯æ±‡ = éš¾ï¼‰
    3. é¢˜å‹ï¼ˆè§£ç­”é¢˜ > å¡«ç©ºé¢˜ > é€‰æ‹©é¢˜ï¼‰
    4. çŸ¥è¯†ç‚¹æ•°é‡ï¼ˆå¤š = éš¾ï¼‰
    
    è¿”å›ï¼šeasy / medium / hard
    """
```

### æ‰¹æ”¹ç­–ç•¥é€‰æ‹©
```python
GRADING_STRATEGIES = {
    'keyword_match': {
        'description': 'å…³é”®è¯åŒ¹é…',
        'suitable_for': ['choice', 'fill'],
        'prompt_template': 'keyword_match_prompt.txt'
    },
    'semantic': {
        'description': 'è¯­ä¹‰ç†è§£',
        'suitable_for': ['fill', 'essay'],
        'prompt_template': 'semantic_prompt.txt'
    },
    'rubric': {
        'description': 'è¯„åˆ†æ ‡å‡†',
        'suitable_for': ['essay', 'calculation'],
        'prompt_template': 'rubric_prompt.txt'
    },
    'step_by_step': {
        'description': 'æ­¥éª¤æ£€æŸ¥',
        'suitable_for': ['calculation'],
        'prompt_template': 'step_by_step_prompt.txt'
    }
}
```

---

## ğŸ“‹ RubricInterpreter Agent è¯¦ç»†è®¾è®¡

### åŠŸèƒ½æè¿°
è§£æè¯„åˆ†æ ‡å‡†ï¼Œç”Ÿæˆç»“æ„åŒ–çš„è¯„åˆ†è§„åˆ™

### è¯„åˆ†æ ‡å‡†æ ¼å¼æ”¯æŒ
```
æ ¼å¼1ï¼šåˆ†æ•°åˆ¶
10åˆ†ï¼šå®Œå…¨æ­£ç¡®
8åˆ†ï¼šåŸºæœ¬æ­£ç¡®ï¼Œæœ‰å°é”™è¯¯
5åˆ†ï¼šéƒ¨åˆ†æ­£ç¡®
0åˆ†ï¼šå®Œå…¨é”™è¯¯

æ ¼å¼2ï¼šç­‰çº§åˆ¶
Aï¼šä¼˜ç§€ï¼ˆ90-100åˆ†ï¼‰
Bï¼šè‰¯å¥½ï¼ˆ80-89åˆ†ï¼‰
Cï¼šåŠæ ¼ï¼ˆ60-79åˆ†ï¼‰
Dï¼šä¸åŠæ ¼ï¼ˆ<60åˆ†ï¼‰

æ ¼å¼3ï¼šç»´åº¦åˆ¶
å‡†ç¡®æ€§ï¼ˆ50%ï¼‰ï¼š
  - å®Œå…¨æ­£ç¡®ï¼š10åˆ†
  - åŸºæœ¬æ­£ç¡®ï¼š8åˆ†
  - éƒ¨åˆ†æ­£ç¡®ï¼š5åˆ†
å®Œæ•´æ€§ï¼ˆ30%ï¼‰ï¼š
  - å®Œæ•´ï¼š10åˆ†
  - åŸºæœ¬å®Œæ•´ï¼š7åˆ†
  - ä¸å®Œæ•´ï¼š3åˆ†
æ¸…æ™°æ€§ï¼ˆ20%ï¼‰ï¼š
  - æ¸…æ™°ï¼š10åˆ†
  - åŸºæœ¬æ¸…æ™°ï¼š6åˆ†
  - ä¸æ¸…æ™°ï¼š2åˆ†
```

### è§£æç®—æ³•
```python
def parse_rubric(text: str) -> Dict:
    """
    è§£æè¯„åˆ†æ ‡å‡†
    
    æ­¥éª¤ï¼š
    1. è¯†åˆ«è¯„åˆ†æ ‡å‡†æ ¼å¼
    2. æå–è¯„åˆ†ç»´åº¦
    3. æå–è¯„åˆ†ç­‰çº§
    4. æå–æƒé‡
    5. ç”Ÿæˆè¯„åˆ†æŒ‡å—
    """
    
def extract_dimensions(rubric_text: str) -> List[Dict]:
    """
    æå–è¯„åˆ†ç»´åº¦
    
    è¿”å›ï¼š
    [
        {
            'name': 'å‡†ç¡®æ€§',
            'weight': 0.5,
            'levels': [
                {'score': 10, 'description': 'å®Œå…¨æ­£ç¡®'},
                {'score': 8, 'description': 'åŸºæœ¬æ­£ç¡®'}
            ]
        }
    ]
    """
```

---

## â­ QuestionGrader Agent è¯¦ç»†è®¾è®¡

### åŠŸèƒ½æè¿°
å¯¹å•ä¸ªé¢˜ç›®è¿›è¡Œæ‰¹æ”¹ï¼Œç”Ÿæˆå¾—åˆ†å’Œè¯¦ç»†åé¦ˆ

### æ‰¹æ”¹æµç¨‹
```
1. å‡†å¤‡æ‰¹æ”¹ä¸Šä¸‹æ–‡
   - é¢˜ç›®ä¿¡æ¯
   - å­¦ç”Ÿç­”æ¡ˆ
   - è¯„åˆ†æ ‡å‡†
   - æ‰¹æ”¹ç­–ç•¥

2. è°ƒç”¨LLMè¿›è¡Œæ‰¹æ”¹
   - ä½¿ç”¨ç²¾å¿ƒè®¾è®¡çš„prompt
   - æŒ‡å®šè¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰
   - è®¾ç½®temperatureå’Œtop_p

3. è§£æLLMè¾“å‡º
   - æå–å¾—åˆ†
   - æå–åé¦ˆ
   - æå–é”™è¯¯ä¿¡æ¯
   - æå–çŸ¥è¯†ç‚¹

4. éªŒè¯å’Œè°ƒæ•´
   - æ£€æŸ¥å¾—åˆ†èŒƒå›´
   - æ£€æŸ¥åé¦ˆè´¨é‡
   - å¿…è¦æ—¶è¿›è¡ŒäºŒæ¬¡è°ƒç”¨

5. è¿”å›ç»“æœ
```

### Prompt è®¾è®¡
```
ç³»ç»Ÿæç¤ºè¯ï¼š
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•™è‚²è¯„ä¼°ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®è¯„åˆ†æ ‡å‡†å¯¹å­¦ç”Ÿçš„ç­”æ¡ˆè¿›è¡Œæ‰¹æ”¹ã€‚
è¯·æä¾›ï¼š
1. å¾—åˆ†ï¼ˆ0-{max_score}ï¼‰
2. ç­‰çº§ï¼ˆA/B/C/Dï¼‰
3. ä¼˜ç‚¹ï¼ˆåˆ—è¡¨ï¼‰
4. ç¼ºç‚¹ï¼ˆåˆ—è¡¨ï¼‰
5. æ”¹è¿›å»ºè®®ï¼ˆåˆ—è¡¨ï¼‰
6. é”™è¯¯åˆ†æï¼ˆåŒ…æ‹¬é”™è¯¯ç±»å‹ã€ä½ç½®ã€ä¸¥é‡ç¨‹åº¦ï¼‰
7. çŸ¥è¯†ç‚¹åˆ†æï¼ˆæ¶‰åŠçš„çŸ¥è¯†ç‚¹å’ŒæŒæ¡ç¨‹åº¦ï¼‰

è¾“å‡ºæ ¼å¼å¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONã€‚

ç”¨æˆ·æç¤ºè¯ï¼š
é¢˜ç›®ï¼š{question_text}
å­¦ç”Ÿç­”æ¡ˆï¼š{student_answer}
è¯„åˆ†æ ‡å‡†ï¼š{rubric}
æ‰¹æ”¹ç­–ç•¥ï¼š{strategy}

è¯·è¿›è¡Œæ‰¹æ”¹ã€‚
```

### é”™è¯¯è¯†åˆ«
```python
ERROR_TYPES = {
    'grammar': 'è¯­æ³•é”™è¯¯',
    'logic': 'é€»è¾‘é”™è¯¯',
    'knowledge': 'çŸ¥è¯†ç‚¹é”™è¯¯',
    'spelling': 'æ‹¼å†™é”™è¯¯',
    'incomplete': 'ç­”æ¡ˆä¸å®Œæ•´',
    'irrelevant': 'ç­”éæ‰€é—®'
}

def identify_errors(question: Dict, answer: Dict, llm_output: Dict) -> List[Dict]:
    """
    è¯†åˆ«é”™è¯¯
    
    è¿”å›ï¼š
    [
        {
            'type': 'grammar',
            'severity': 'high',
            'location': 'ç¬¬2æ®µç¬¬3å¥',
            'description': 'ä¸»è¯­å’Œè°“è¯­ä¸ä¸€è‡´',
            'correction': 'åº”è¯¥æ˜¯...'
        }
    ]
    """
```

### çŸ¥è¯†ç‚¹æå–
```python
def extract_knowledge_points(question: Dict, answer: Dict, llm_output: Dict) -> List[Dict]:
    """
    æå–çŸ¥è¯†ç‚¹
    
    è¿”å›ï¼š
    [
        {
            'name': 'äºŒæ¬¡å‡½æ•°',
            'mastery_level': 0.8,  # 0-1
            'gaps': ['é¡¶ç‚¹åæ ‡è®¡ç®—', 'å¯¹ç§°è½´']
        }
    ]
    """
```

---

## ğŸ”— ResultAggregator Agent è¯¦ç»†è®¾è®¡

### åŠŸèƒ½æè¿°
èšåˆæ‰€æœ‰é¢˜ç›®çš„æ‰¹æ”¹ç»“æœï¼Œç”Ÿæˆæ•´ä½“æŠ¥å‘Š

### èšåˆç®—æ³•
```python
def aggregate_results(grading_results: List[Dict]) -> Dict:
    """
    èšåˆç»“æœ
    
    æ­¥éª¤ï¼š
    1. è®¡ç®—æ€»åˆ†ï¼ˆåŠ æƒæ±‚å’Œï¼‰
    2. è®¡ç®—ç­‰çº§ï¼ˆæ ¹æ®æ€»åˆ†ï¼‰
    3. ç»Ÿè®¡é”™è¯¯åˆ†å¸ƒ
    4. åˆ†æçŸ¥è¯†ç‚¹æŒæ¡åº¦
    5. ç”Ÿæˆæ”¹è¿›å»ºè®®
    """
    
def calculate_total_score(results: List[Dict]) -> float:
    """
    è®¡ç®—æ€»åˆ†
    
    å…¬å¼ï¼š
    total_score = sum(result['score'] for result in results)
    """
    
def calculate_grade_level(total_score: float, max_score: float) -> str:
    """
    è®¡ç®—ç­‰çº§
    
    æ ‡å‡†ï¼š
    90-100: A
    80-89: B
    70-79: C
    60-69: D
    <60: F
    """
    
def analyze_knowledge_points(results: List[Dict]) -> List[Dict]:
    """
    åˆ†æçŸ¥è¯†ç‚¹æŒæ¡åº¦
    
    è¿”å›ï¼š
    [
        {
            'name': 'çŸ¥è¯†ç‚¹åç§°',
            'mastery': 0.8,  # å¹³å‡æŒæ¡åº¦
            'gaps': ['ç¼ºé™·1', 'ç¼ºé™·2']
        }
    ]
    """
```

---

## ğŸ’¾ DataPersistence Agent è¯¦ç»†è®¾è®¡

### åŠŸèƒ½æè¿°
å°†æ‰¹æ”¹ç»“æœå­˜å‚¨åˆ°æ•°æ®åº“

### å­˜å‚¨æµç¨‹
```
1. éªŒè¯æ•°æ®
   - æ£€æŸ¥å¿…å¡«å­—æ®µ
   - æ£€æŸ¥æ•°æ®ç±»å‹
   - æ£€æŸ¥æ•°æ®èŒƒå›´

2. å­˜å‚¨å­¦ç”Ÿä¿¡æ¯
   - æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å­˜åœ¨
   - å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
   - è¿”å›å­¦ç”ŸID

3. å­˜å‚¨æ‰¹æ”¹ä»»åŠ¡
   - åˆ›å»ºä»»åŠ¡è®°å½•
   - è¿”å›ä»»åŠ¡ID

4. å­˜å‚¨é€é¢˜ç»“æœ
   - ä¸ºæ¯é“é¢˜åˆ›å»ºè®°å½•
   - å­˜å‚¨é”™è¯¯ä¿¡æ¯
   - å­˜å‚¨çŸ¥è¯†ç‚¹ä¿¡æ¯

5. å­˜å‚¨ç»Ÿè®¡æ•°æ®
   - è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
   - å­˜å‚¨åˆ°ç»Ÿè®¡è¡¨

6. å»ºç«‹å…³è”å…³ç³»
   - å…³è”å­¦ç”Ÿå’Œä»»åŠ¡
   - å…³è”ä»»åŠ¡å’Œç»“æœ
   - å…³è”ç»“æœå’Œé”™è¯¯

7. æäº¤äº‹åŠ¡
   - ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
   - å¤„ç†å†²çª
```

### äº‹åŠ¡å¤„ç†
```python
def save_grading_result(result: Dict, db_session) -> Dict:
    """
    ä¿å­˜æ‰¹æ”¹ç»“æœ
    
    ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼š
    - å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼Œå›æ»šæ‰€æœ‰æ›´æ”¹
    - å¦‚æœæˆåŠŸï¼Œæäº¤æ‰€æœ‰æ›´æ”¹
    """
    try:
        # å¼€å§‹äº‹åŠ¡
        with db_session.begin():
            # ä¿å­˜å­¦ç”Ÿä¿¡æ¯
            student = save_student(result['student_info'])
            
            # ä¿å­˜æ‰¹æ”¹ä»»åŠ¡
            task = save_grading_task(result['task_id'], student.id)
            
            # ä¿å­˜é€é¢˜ç»“æœ
            for question_result in result['grading_results']:
                save_question_result(task.id, question_result)
            
            # ä¿å­˜ç»Ÿè®¡æ•°æ®
            save_statistics(task.id, result['statistics'])
            
        return {'success': True, 'task_id': result['task_id']}
        
    except Exception as e:
        # äº‹åŠ¡è‡ªåŠ¨å›æ»š
        return {'success': False, 'error': str(e)}
```

---

## ğŸ”„ Agent é—´æ•°æ®æµè½¬

### æ•°æ®æµå›¾
```
InputParser
    â†“
    {questions, answers, student_info}
    â†“
QuestionAnalyzer + RubricInterpreter
    â†“
    {questions_analyzed, rubric}
    â†“
QuestionGrader (å¯¹æ¯ä¸ªé¢˜ç›®)
    â†“
    {grading_results}
    â†“
ResultAggregator
    â†“
    {aggregated_result}
    â†“
DataPersistence
    â†“
    {success, task_id}
```

### æ•°æ®è½¬æ¢è§„åˆ™
```python
# InputParser â†’ QuestionAnalyzer
{
    'questions': List[Dict]  # åŸå§‹é¢˜ç›®
}

# QuestionAnalyzer â†’ QuestionGrader
{
    'questions_analyzed': List[Dict],  # åˆ†æåçš„é¢˜ç›®
    'grading_strategy': str  # æ‰¹æ”¹ç­–ç•¥
}

# QuestionGrader â†’ ResultAggregator
{
    'grading_results': List[Dict]  # æ‰€æœ‰é¢˜ç›®çš„æ‰¹æ”¹ç»“æœ
}

# ResultAggregator â†’ DataPersistence
{
    'aggregated_result': Dict,  # èšåˆåçš„ç»“æœ
    'statistics': Dict  # ç»Ÿè®¡æ•°æ®
}
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- æ¯ä¸ªAgentçš„è¾“å…¥/è¾“å‡ºæµ‹è¯•
- è¾¹ç•Œæƒ…å†µæµ‹è¯•
- é”™è¯¯å¤„ç†æµ‹è¯•

### é›†æˆæµ‹è¯•
- Agenté—´çš„æ•°æ®æµè½¬æµ‹è¯•
- å®Œæ•´å·¥ä½œæµæµ‹è¯•
- æ•°æ®åº“æ“ä½œæµ‹è¯•

### æ€§èƒ½æµ‹è¯•
- å•é¢˜æ‰¹æ”¹æ—¶é—´
- æ‰¹é‡æ‰¹æ”¹æ—¶é—´
- Tokenä½¿ç”¨é‡
- å†…å­˜å ç”¨

### è´¨é‡æµ‹è¯•
- æ‰¹æ”¹å‡†ç¡®åº¦
- åé¦ˆè´¨é‡
- çŸ¥è¯†ç‚¹æå–å‡†ç¡®åº¦

